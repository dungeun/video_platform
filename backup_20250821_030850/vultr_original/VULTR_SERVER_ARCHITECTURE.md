# 🏗️ Vultr 서버 아키텍처 설계서

## 📋 프로젝트 요구사항 분석

### 현재 프로젝트 구성 요소
1. **PostgreSQL 데이터베이스** (현재 외부 서버 사용 중)
2. **Redis 캐시 서버** (현재 외부 서버 사용 중)
3. **라이브 스트리밍 서버** (Node Media Server)
4. **채팅 서버** (Socket.io)
5. **대용량 파일 업로드** (TUS Protocol, 5GB+)
6. **비디오 처리** (FFmpeg 트랜스코딩)
7. **Next.js 웹 애플리케이션**

---

## 🖥️ Vultr 서버 구성 계획 (국내용)

### 1️⃣ 메인 애플리케이션 서버
**용도**: Next.js 앱 + API 서버
- **스펙**: 2 vCPU, 4GB RAM, 80GB NVMe SSD
- **OS**: Ubuntu 22.04 LTS
- **위치**: Seoul (한국)
- **예상 비용**: $24/월
- **구성 요소**:
  - Next.js 애플리케이션
  - API 서버
  - Nginx (리버스 프록시)
  - PM2 (프로세스 매니저)

### 2️⃣ 스트리밍 & 미디어 서버
**용도**: 라이브 스트리밍 + 비디오 처리
- **스펙**: 4 vCPU, 8GB RAM, 160GB NVMe SSD
- **OS**: Ubuntu 22.04 LTS
- **위치**: Seoul (한국)
- **예상 비용**: $48/월
- **구성 요소**:
  - Node Media Server (RTMP/HLS)
  - FFmpeg (트랜스코딩)
  - TUS Server (대용량 업로드)
  - 녹화 시스템

### 3️⃣ 데이터베이스 서버
**용도**: PostgreSQL + Redis
- **스펙**: 2 vCPU, 8GB RAM, 160GB NVMe SSD
- **OS**: Ubuntu 22.04 LTS
- **위치**: Seoul (한국)
- **예상 비용**: $48/월
- **구성 요소**:
  - PostgreSQL 15
  - Redis 7
  - 자동 백업 시스템
  - 모니터링 도구

### 4️⃣ 채팅 & 실시간 서버
**용도**: Socket.io 채팅 서버
- **스펙**: 2 vCPU, 4GB RAM, 80GB NVMe SSD
- **OS**: Ubuntu 22.04 LTS
- **위치**: Seoul (한국)
- **예상 비용**: $24/월
- **구성 요소**:
  - Socket.io 서버
  - Redis Pub/Sub
  - 메시지 큐 시스템

### 5️⃣ 스토리지 (Block Storage)
**용도**: 비디오 파일 저장
- **용량**: 1TB (확장 가능)
- **타입**: NVMe Block Storage
- **위치**: Seoul (한국)
- **예상 비용**: $100/월
- **용도**:
  - 녹화 파일 저장
  - 업로드된 비디오 저장
  - 썸네일 이미지 저장
  - 임시 트랜스코딩 파일

---

## 💰 총 비용 예상

| 서버 타입 | 월 비용 | 연간 비용 |
|----------|---------|-----------|
| 애플리케이션 서버 | $24 | $288 |
| 스트리밍 서버 | $48 | $576 |
| 데이터베이스 서버 | $48 | $576 |
| 채팅 서버 | $24 | $288 |
| Block Storage (1TB) | $100 | $1,200 |
| **합계** | **$244/월** | **$2,928/년** |

**추가 비용 고려사항**:
- 네트워크 트래픽: ~$50-100/월 (예상)
- 백업 스냅샷: ~$20/월
- **실제 예상 총 비용: $350-400/월**

---

## 🔄 서버 간 통신 구조

```
[사용자] 
    ↓
[로드 밸런서/Nginx]
    ↓
[애플리케이션 서버]
    ├→ [데이터베이스 서버]
    │   ├─ PostgreSQL (5432)
    │   └─ Redis (6379)
    ├→ [스트리밍 서버]
    │   ├─ RTMP (1935)
    │   ├─ HTTP-FLV (8000)
    │   └─ HLS (8080)
    ├→ [채팅 서버]
    │   └─ Socket.io (3001)
    └→ [Block Storage]
        └─ 마운트: /mnt/storage
```

---

## 🚀 배포 단계별 계획

### Phase 1: 기본 인프라 (1주차)
1. Vultr 계정 설정 및 API 키 생성
2. 애플리케이션 서버 생성
3. 데이터베이스 서버 생성
4. 기본 네트워킹 설정

### Phase 2: 스트리밍 인프라 (2주차)
1. 스트리밍 서버 생성
2. Node Media Server 설치
3. FFmpeg 설정
4. Block Storage 연결

### Phase 3: 실시간 기능 (3주차)
1. 채팅 서버 생성
2. Socket.io 클러스터 설정
3. Redis Pub/Sub 연결
4. 로드 밸런싱 설정

### Phase 4: 최적화 & 모니터링 (4주차)
1. 성능 최적화
2. 모니터링 시스템 구축
3. 자동 백업 설정
4. 보안 강화

---

## 🔐 보안 설정

### 네트워크 보안
- **Private Network**: 서버 간 내부 통신용
- **Firewall Rules**:
  - 애플리케이션: 80, 443 (HTTP/HTTPS)
  - 스트리밍: 1935 (RTMP), 8000-8080 (HLS/FLV)
  - 데이터베이스: Private Network Only
  - 채팅: 3001 (Socket.io)

### 접근 제어
- SSH 키 인증만 허용
- fail2ban 설치
- 정기적인 보안 업데이트
- WAF (Web Application Firewall) 고려

---

## 📊 성능 목표

### 동시 접속자 처리 능력
- **라이브 스트리밍**: 500-1000명 동시 시청
- **채팅**: 2000명 동시 접속
- **파일 업로드**: 50개 동시 업로드 (5GB 파일)
- **API 응답**: <200ms (95 percentile)

### 스케일링 전략
- **수직 스케일링**: 필요시 서버 스펙 업그레이드
- **수평 스케일링**: 
  - 애플리케이션 서버 추가 (로드 밸런서 사용)
  - 스트리밍 서버 추가 (지역별 분산)
  - 읽기 전용 DB 복제본 추가

---

## 🔧 관리 도구

### 모니터링
- **Grafana + Prometheus**: 시스템 메트릭
- **ELK Stack**: 로그 수집 및 분석
- **Uptime Kuma**: 서비스 가용성 모니터링

### 자동화
- **Ansible**: 서버 구성 자동화
- **GitHub Actions**: CI/CD 파이프라인
- **Terraform**: 인프라 as Code

---

## 📝 주요 고려사항

### 장점
✅ 한국 리전 사용으로 낮은 레이턴시
✅ 각 서비스별 독립적인 서버로 안정성 확보
✅ 유연한 스케일링 가능
✅ Block Storage로 대용량 파일 처리

### 단점
❌ 초기 비용 부담 ($350-400/월)
❌ 서버 관리 복잡도 증가
❌ 멀티 서버 간 네트워크 설정 필요

### 대안 검토
- **단일 고성능 서버**: 모든 서비스를 하나의 강력한 서버에서 운영
  - 장점: 관리 간편, 비용 절감
  - 단점: 단일 장애점, 스케일링 어려움

---

## 📅 예상 타임라인

| 주차 | 작업 내용 | 예상 시간 |
|------|-----------|-----------|
| 1주차 | 기본 인프라 구축 | 40시간 |
| 2주차 | 스트리밍 시스템 구현 | 40시간 |
| 3주차 | 실시간 기능 구현 | 40시간 |
| 4주차 | 최적화 및 테스트 | 40시간 |
| **총계** | **전체 구축** | **160시간** |

---

## 🎯 다음 단계

1. **Vultr API 키 받기**
2. **최종 서버 스펙 확정**
3. **자동화 스크립트 작성**
4. **단계별 배포 시작**

---

*작성일: 2024년 12월*
*작성자: VideoPick Platform Team*